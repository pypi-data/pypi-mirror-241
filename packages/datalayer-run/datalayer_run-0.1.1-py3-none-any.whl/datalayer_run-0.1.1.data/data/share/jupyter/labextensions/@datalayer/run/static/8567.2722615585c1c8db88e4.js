"use strict";(self.webpackChunk_datalayer_run=self.webpackChunk_datalayer_run||[]).push([[8567],{99870:(e,t,s)=>{s.d(t,{Ll:()=>n,qP:()=>a,vM:()=>i});var r=s(97930);const n=new r.Token("@datalayer/jupyterlite-kernel:IKernels"),i="javascript",a=new r.Token("@datalayer/jupyterlite-kernel:IKernelSpecs")},88567:(e,t,s)=>{s.r(t),s.d(t,{default:()=>b});var r=s(5987),n=s(99870),i=s(32001),a=s(72375),o=s(97930),c=s(2876),l=s(60255);class g{constructor(e){const{kernelspecs:t}=e;this._kernelspecs=t}async startNew(e){const{id:t,name:s,location:r}=e,n=this._kernelspecs.factories.get(s);if(!n)return{id:t,name:s};const i=new l.WU,u=(e,t,s)=>{const r=this._kernels.get(e);if(!r)throw Error(`No kernel ${e}`);this._clients.set(t,s),this._kernelClients.get(e)?.add(t),s.on("message",(async e=>{let t;if(e instanceof ArrayBuffer)e=new Uint8Array(e).buffer,t=(0,a.deserialize)(e,"v1.kernel.websocket.jupyter.org");else{if("string"!=typeof e)return;{const s=(new TextEncoder).encode(e);t=(0,a.deserialize)(s,"v1.kernel.websocket.jupyter.org")}}"input_reply"===t.header.msg_type?r.handleMessage(t):(async e=>{await i.runExclusive((async()=>{await r.handleMessage(e)}))})(t)}));const n=()=>{this._clients.delete(t),this._kernelClients.get(e)?.delete(t)};r.disposed.connect(n),s.onclose=n},d=t??o.UUID.uuid4(),p=`${g.WS_BASE_URL}api/kernels/${d}/channels`,h=this._kernels.get(d);if(h)return{id:h.id,name:h.name};const y=await n({id:d,sendMessage:e=>{const t=e.header.session,s=this._clients.get(t);if(!s)return void console.warn(`Trying to send message on removed socket for kernel ${d}`);const r=(0,a.serialize)(e,"v1.kernel.websocket.jupyter.org");if("iopub"!==e.channel)s.send(r);else{const e=this._kernelClients.get(d);e?.forEach((e=>{this._clients.get(e)?.send(r)}))}},name:s,location:r});await y.ready,this._kernels.set(d,y),this._kernelClients.set(d,new Set);const f=new c.Server(p);return f.on("connection",(e=>{const t=new URL(e.url).searchParams.get("session_id")??"";u(d,t,e)})),f.on("close",(()=>{this._clients.keys().forEach((e=>{const t=this._clients.get(e);t?.readyState===WebSocket.CLOSED&&(this._clients.delete(e),this._kernelClients.get(d)?.delete(e))}))})),y.disposed.connect((()=>{f.close(),this._kernels.delete(d),this._kernelClients.delete(d)})),{id:y.id,name:y.name}}async restart(e){const t=this._kernels.get(e);if(!t)throw Error(`Kernel ${e} does not exist`);const{id:s,name:r,location:n}=t;return t.dispose(),this.startNew({id:s,name:r,location:n})}async shutdown(e){this._kernels.delete(e)?.dispose()}_kernels=new i.ObservableMap;_clients=new i.ObservableMap;_kernelClients=new i.ObservableMap;_kernelspecs}!function(e){e.WS_BASE_URL=r.PageConfig.getBaseUrl().replace(/^http/,"ws")}(g||(g={}));class u{get specs(){return 0===this._specs.size?null:{default:this.defaultKernelName,kernelspecs:Object.fromEntries(this._specs)}}get defaultKernelName(){let e=r.PageConfig.getOption("defaultKernelName");if(!e&&this._specs.size){const t=Array.from(this._specs.keys());t.sort(),e=t[0]}return e||n.vM}get factories(){return this._factories}register(e){const{spec:t,create:s}=e;this._specs.set(t.name,t),this._factories.set(t.name,s)}_specs=new Map;_factories=new Map}var d=s(15527),p=s(74901);class h{constructor(){this.initialize()}get registrationChanged(){return this._registrationChanged}get enabled(){return null!==this._registration}async initialize(){if("serviceWorker"in navigator||(console.error("ServiceWorker registration failed: Service Workers not supported in this browser"),this.setRegistration(null)),navigator.serviceWorker.controller){const e=await navigator.serviceWorker.getRegistration(navigator.serviceWorker.controller.scriptURL);e&&this.setRegistration(e)}return await navigator.serviceWorker.register("/services.js").then((e=>{this.setRegistration(e)}),(e=>{console.error(`ServiceWorker registration failed: ${e}`),this.setRegistration(null)}))}setRegistration(e){this._registration=e,this._registrationChanged.emit(this._registration)}_registration=null;_registrationChanged=new p.Signal(this)}const y=new o.Token("@datalayer/jupyterlite-session:ISessions");var f=s(96697);class w{constructor(e){this._kernels=e.kernels}async get(e){const t=this._sessions.find((t=>t.id===e));if(!t)throw Error(`Session ${e} not found`);return t}async list(){return this._sessions}async patch(e){const{id:t,path:s,name:r}=e,n=this._sessions.findIndex((e=>e.id===t)),i=this._sessions[n];if(!i)throw Error(`Session ${t} not found`);const a={...i,path:s??i.path,name:r??i.name};return this._sessions[n]=a,a}async startNew(e){const{path:t,name:s}=e,n=this._sessions.find((e=>e.name===s));if(n)return n;const i=e.kernel?.name??"",a=e.id??o.UUID.uuid4(),c=await this._kernels.startNew({id:a,name:i,location:r.PathExt.dirname(e.path)}),l={id:a,path:t,name:s??t,type:"notebook",kernel:{id:c.id,name:c.name}};return this._sessions.push(l),l}async shutdown(e){const t=this._sessions.find((t=>t.id===e));if(!t)throw Error(`Session ${e} not found`);const s=t.kernel?.id;s&&await this._kernels.shutdown(s),f.ArrayExt.removeFirstOf(this._sessions,t)}_kernels;_sessions=[]}const _=new o.Token("@datalayer/jupyterlite-settings:ISettings");var v=s(7663);const k="JupyterLite Storage";class m{constructor(e){this._localforage=e.localforage,this._storageName=e.storageName||k,this._storageDrivers=e.storageDrivers||null,this._ready=new o.PromiseDelegate}get ready(){return this._ready.promise}get storage(){return this.ready.then((()=>this._storage))}async initialize(){await this.initStorage(),this._ready.resolve(void 0)}async initStorage(){this._storage=this.defaultSettingsStorage()}get defaultStorageOptions(){const e=this._storageDrivers?.length?this._storageDrivers:null;return{version:1,name:this._storageName,...e?{driver:e}:{}}}defaultSettingsStorage(){return this._localforage.createInstance({description:"Offline Storage for Settings",storeName:"settings",...this.defaultStorageOptions})}async get(e){let t=(await this.getAll()).settings.find((t=>t.id===e));return t||(t=await this._getFederated(e)),t}async getAll(){const e=r.PageConfig.getOption("settingsUrl")??"/",t=await this.storage,s=await(await fetch(r.URLExt.join(e,"all.json"))).json();return{settings:await Promise.all(s.map((async e=>{const{id:s}=e,r=await t.getItem(s)??e.raw;return{...S.override(e),raw:r,settings:v.parse(r)}})))}}async save(e,t){await(await this.storage).setItem(e,t)}async _getFederated(e){const[t,s]=e.split(":");if(!S.isFederated(t))return;const n=r.PageConfig.getOption("fullLabextensionsUrl"),i=r.URLExt.join(n,t,"schemas",t,`${s}.json`),a=r.URLExt.join(n,t,"package.json"),o=await(await fetch(i)).json(),c=await(await fetch(a)).json(),l=await(await this.storage).getItem(e)??"{}",g=v.parse(l)||{};return S.override({id:e,raw:l,schema:o,settings:g,version:c.version||"3.0.8"})}_storageName=k;_storageDrivers=null;_storage;_localforage;_ready}var S;!function(e){const t=JSON.parse(r.PageConfig.getOption("settingsOverrides")||"{}");e.isFederated=function(e){let t;try{t=JSON.parse(r.PageConfig.getOption("federated_extensions"))}catch{return!1}for(const{name:s}of t)if(s===e)return!0;return!1},e.override=function(e){if(t[e.id]){e.schema.properties||(e.schema.properties={});for(const[s,r]of Object.entries(t[e.id]||{}))e.schema.properties[s].default=r}return e}}(S||(S={}));var j=s(23961),O=s.n(j);const N={id:"@datalayer/jupyterlite-server-extension:service-worker",autoStart:!0,provides:d.g,activate:e=>new h},R={id:"@datalayer/jupyterlite-server-extension:settings-routes",autoStart:!0,requires:[_],activate:(e,t)=>{const s="/api/settings/((?:@([^/]+?)[/])?([^/]+?):([^:]+))$";e.router.get(s,(async(e,s)=>{const r=await t.get(s);return new Response(JSON.stringify(r))})),e.router.put(s,(async(e,s)=>{const r=e.body,{raw:n}=r;return await t.save(s,n),new Response(null,{status:204})})),e.router.get("/api/settings",(async e=>{const s=await t.getAll();return new Response(JSON.stringify(s))}))}},b=[{id:"@datalayer/jupyterlite-server-extension:kernels",autoStart:!0,provides:n.Ll,requires:[n.qP],activate:(e,t)=>new g({kernelspecs:t})},{id:"@datalayer/jupyterlite-server-extension:kernels-routes",autoStart:!0,requires:[n.Ll],activate:(e,t)=>{e.router.post("/api/kernels/(.*)/restart",(async(e,s)=>{const r=await t.restart(s);return new Response(JSON.stringify(r))})),e.router.delete("/api/kernels/(.*)",(async(e,s)=>{const r=await t.shutdown(s);return new Response(JSON.stringify(r),{status:204})}))}},{id:"@datalayer/jupyterlite-server-extension:kernelspec",autoStart:!0,provides:n.qP,activate:e=>new u},{id:"@datalayer/jupyterlite-server-extension:kernelspec-routes",autoStart:!0,requires:[n.qP],activate:(e,t)=>{e.router.get("/api/kernelspecs",(async e=>{const{specs:s}=t;if(!s)return new Response(null);const r={},n=s.kernelspecs;Object.keys(n).forEach((e=>{const t=n[e],{resources:s}=t??{};r[e]={name:e,spec:t,resources:s}}));const i={default:s.default,kernelspecs:r};return new Response(JSON.stringify(i))}))}},{id:"@datalayer/jupyterlite-server-extension:nbconvert-routes",autoStart:!0,activate:e=>{e.router.get("/api/nbconvert",(async e=>new Response(JSON.stringify({}))))}},N,{id:"@datalayer/jupyterlite-server-extension:sessions",autoStart:!0,provides:y,requires:[n.Ll],activate:(e,t)=>new w({kernels:t})},{id:"@datalayer/jupyterlite-server-extension:sessions-routes",autoStart:!0,requires:[y],activate:(e,t)=>{e.router.get("/api/sessions/(.+)",(async(e,s)=>{const r=await t.get(s);return new Response(JSON.stringify(r),{status:200})})),e.router.get("/api/sessions",(async e=>{const s=await t.list();return new Response(JSON.stringify(s),{status:200})})),e.router.patch("/api/sessions(.*)",(async(e,s)=>{const r=e.body,n=await t.patch(r);return new Response(JSON.stringify(n),{status:200})})),e.router.delete("/api/sessions/(.+)",(async(e,s)=>(await t.shutdown(s),new Response(null,{status:204})))),e.router.post("/api/sessions",(async e=>{const s=e.body,r=await t.startNew(s);return new Response(JSON.stringify(r),{status:201})}))}},{id:"@datalayer/jupyterlite-server-extension:settings",autoStart:!0,requires:[],provides:_,activate:e=>{const t=r.PageConfig.getOption("settingsStorageName"),s=JSON.parse(r.PageConfig.getOption("settingsStorageDrivers")||"null"),n=new m({storageName:t,storageDrivers:s,localforage:O()});return e.started.then((()=>n.initialize().catch(console.warn))),n}},R]},15527:(e,t,s)=>{s.d(t,{g:()=>r});const r=new(s(97930).Token)("@datalayer/jupyterlite-server-extension:IServiceWorkerRegistrationWrapper")}}]);