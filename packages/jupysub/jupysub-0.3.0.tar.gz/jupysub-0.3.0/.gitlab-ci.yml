image: python:latest

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

before_script:
  - python --version ; pip --version  # for debugging purposes
  - pip install virtualenv
  - virtualenv venv
  - source venv/bin/activate

build:
  before_script:
    - pip install build
  script:
    - python -m build
  artifacts:
    paths:
      - dist/*

test:
  needs:
    - job: build
      artifacts: true
  before_script:
    - python -m pip install dist/jupysub-*.whl
    - python -m pip install numpy scipy matplotlib pytest # required for parsing notebooks
  script:
    - pytest tests

deploy:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  needs:
    - job: build
      artifacts: true
    - job: test
  before_script:
    - python -m pip install twine
  script:
    - twine upload -u __token__ -p ${pypi_token} dist/*

deployment-verification:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  needs:
    - job: deploy
  before_script:
    - python -m pip install numpy scipy matplotlib pytest jupysub
  script:
    - pytest tests
